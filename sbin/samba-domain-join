#!/usr/bin/env bash

# Exit if any error
set -euo pipefail

# Require DC as argument
test "${#}" -ge 1 || { echo "Usage: samba-domain-join <server>"; exit 1; }
server="${1}"

# Wait until dc LDAP response
until nc -z "${server}" 389; do
  echo "Waiting 5 seconds for ${server} LDAP response.."
  sleep 1
done

if [[ ! -e "${SAMBA_PATH:-/usr/local/samba}/private/secrets.keytab" ]]; then
  INTERFACE=$(ip a | grep BROADCAST | head -n1 | awk '{print $2}' | sed 's/://')
  samba-tool domain join "${REALM}" "${SERVER_ROLE:-dc}" \
    --server="${server}" \
    --username=administrator \
    --password="${ADMIN_PASS}" \
    --dns-backend="${DNS_BACKEND:-SAMBA_INTERNAL}" \
    --option="dns forwarder=${DNS_FORWARDER}" \
    --option="interfaces=lo ${INTERFACE}" \
    --option="bind interfaces only=yes" || \
  echo "Skipping domain join.."
fi

update-etc-files
